<!doctype html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆåˆ—è¡¨</title>
    <link href="/css/style.css" rel="stylesheet" type="text/css" media="all">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="https://unpkg.com/pjax@0.2.8/pjax.min.js"></script>
    <script type="module" src="/js/main.js" defer></script>
    <style>
        /* æ·»åŠ  CSS æ ·å¼ä»¥æ§åˆ¶æ¸¸æˆåå’Œæ¸¸æˆæ—¶é—´çš„å¸ƒå±€ */
        .game-list ul {
            list-style-type: none; /* å»æ‰é»˜è®¤åˆ—è¡¨æ ·å¼ */
            padding: 0;
        }

        .game-list li {
            display: flex; /* ä½¿ç”¨ Flexbox å¸ƒå±€ */
            justify-content: space-between; /* æ¸¸æˆåä¸æ—¶é—´ä¸¤ç«¯å¯¹é½ */
            margin: 5px 0; /* åˆ—è¡¨é¡¹ä¸Šä¸‹é—´è· */
        }

        .recently {
            background-color: rgba(128, 0, 128, 0.3); /* åŠé€æ˜ç´«è‰²èƒŒæ™¯ */
            padding: 2px; /* å†…è¾¹è· */
            border-radius: 2px; /* åœ†è§’è¾¹æ¡† */
        }

        .game-list {
            padding: 0 15px; /* ç»Ÿä¸€å·¦å³å†…è¾¹è· */
        }

        .explain {
            font-weight: bold; /* ä½¿è§£é‡Šä¿¡æ¯åŠ ç²— */
            margin-bottom: 10px; /* ç»™è§£é‡Šä¿¡æ¯æ·»åŠ ä¸‹è¾¹è· */
            color: #333; /* æ–‡å­—é¢œè‰² */
            background-color: rgba(255, 255, 0, 0.2); /* åŠé€æ˜é»„è‰²èƒŒæ™¯ */
            padding: 10px; /* å†…è¾¹è· */
            border-radius: 5px; /* åœ†è§’è¾¹æ¡† */
        }
    </style>
</head>

<body>
    <div class="logo" onclick="window.location.href='/index.html'"></div>
    <main id="main" class="main">
        <div class="window-body">
            <menu role="tablist"></menu>
            <div class="window" role="tabpanel">
                <div class="window-body">
                    <div class="game-list">
                        <!-- æ¸¸æˆåˆ—è¡¨å°†è¢«æ’å…¥åœ¨è¿™é‡Œ -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button class="back-to-top" onclick="scrollToTop()">
        <img src="/icon/go-top.png" alt="Back to Top" style="vertical-align: middle;">
    </button>
    <div class="crt monitor"></div>
    <div id="loading-container" style="display: none;"></div> <!-- åŠ è½½åŠ¨ç”»å®¹å™¨ -->

    <script>
        const CONFIG_URL = 'game_time_cfg.json';
        const GAME_LIST_HTML_CLASS = '.game-list';
        
        async function fetchGameData() {
            try {
                const response = await fetch(CONFIG_URL);
                const data = await response.json();
    
                const typeNames = parseTypeNames(data[0][0].typeName);
                const explain = formatExplain(data[0][0], data[1]); // ä¼ å…¥æ¸¸æˆæ•°æ®ä»¥è®¡ç®—æ€»æ—¶é•¿
                const games = data[1];
    
                // å…¨å±€æ’åºï¼Œæ ¹æ®æ¸¸æˆæ—¶é•¿è¿›è¡Œé™åºæ’åº
                const sortedGames = games.sort((a, b) => b.time - a.time);
    
                const groupedGames = groupGames(sortedGames); // è¿›è¡Œåˆ†ç»„
                const htmlContent = generateHtmlContent(groupedGames, typeNames, explain); 
                
                document.querySelector(GAME_LIST_HTML_CLASS).innerHTML = htmlContent;
    
            } catch (error) {
                console.error("è¯»å–æ¸¸æˆæ•°æ®å¤±è´¥:", error);
            }
        }
        
        function parseTypeNames(typeNameStr) {
            return typeNameStr.split(',').reduce((acc, curr) => {
                const [key, value] = curr.split(':');
                acc[key] = value;
                return acc;
            }, {});
        }
        
        function formatExplain(data, games) {
            const explainText = data.explain.replace(/\n/g, '<br>') || '';
            const jsonLink = data.jsonLink ? `<br><a href="${data.jsonLink}" target="_blank">æŸ¥çœ‹é…ç½®æ–‡ä»¶</a>` : '';
            
            // è®¡ç®—æ¸¸æˆæ€»æ—¶é•¿
            const totalTime = games.reduce((sum, game) => sum + game.time, 0);
            const totalDays = Math.floor(totalTime / 24); // è®¡ç®—æ€»å¤©æ•°
            const totalYears = (totalTime / 24 / 365).toFixed(2); // è®¡ç®—æ€»å¹´ä»½å¹¶ä¿ç•™ä¸¤ä½å°æ•°
    
            // åœ¨è§£é‡Šæ–‡æœ¬ä¸­æ·»åŠ æ€»æ—¶é•¿ä¿¡æ¯
            return explainText + jsonLink + `<br>æ¸¸æˆæ€»è®¡æ—¶é•¿ï¼š${totalTime}å°æ—¶ï¼Œç›¸å½“äº${totalDays}å¤©ï¼Œç›¸å½“äº${totalYears}å¹´ã€‚`;
        }
    
        function groupGames(games) {
            return games.reduce((acc, game) => {
                const type = game.type;
                const seriesTag = game.seriesTag || "æ— ç³»åˆ—"; // å¦‚æœæ²¡æœ‰ seriesTagï¼Œèµ‹å€¼ä¸º "æ— ç³»åˆ—"
    
                if (!acc[type]) {
                    acc[type] = {};
                }
    
                if (!acc[type][seriesTag]) {
                    acc[type][seriesTag] = [];
                }
    
                acc[type][seriesTag].push(game);
                return acc;
            }, {});
        }
        
        function generateHtmlContent(groupedGames, typeNames, explain) {
            let htmlContent = explain ? `<div class="explain">${explain}</div>` : '';
            const types = Object.keys(groupedGames); // è·å–ç±»å‹çš„æ•°ç»„
            
            for (let i = 0; i < types.length; i++) {
                const type = types[i];
                htmlContent += `<h3>${typeNames[type]}</h3>`;
                const seriesTags = Object.keys(groupedGames[type]); // è·å–ç³»åˆ—æ ‡ç­¾çš„æ•°ç»„
                
                for (const seriesTag of seriesTags) {
                    const sortedGames = groupedGames[type][seriesTag]; // æ’åºåçš„æ¸¸æˆåˆ—è¡¨
    
                    sortedGames.forEach(game => {
                        const recentlyClass = game.isRecently ? 'recently' : ''; // å¦‚æœ isRecently ä¸º trueï¼Œæ·»åŠ ç±»
                        const heart = game.isLoved ? 'ğŸ’œ' : ''; // å¦‚æœ isLoved ä¸º trueï¼Œå±•ç¤ºçˆ±å¿ƒç¬¦å·
                        const sign = game.sign ? game.sign : ''; // è·å– sign å­—æ®µ
    
                        // åˆ¤æ–­æ¸¸æˆåç§°æ˜¯å¦ä¸ºçº¯è‹±æ–‡
                        const gameName = /^[A-Za-z0-9\s]+$/.test(game.name) ? `<i>${game.name}</i>` : game.name;
                        
                        htmlContent += `
                            <li class="${recentlyClass}">
                                <span><strong>${gameName}</strong> ${heart}</span>
                                <span>${sign} ${game.time}å°æ—¶</span>
                            </li>
                        `;
                    });
                }
    
                if (i < types.length - 1) {
                    htmlContent += `<hr>`; // åœ¨æ¯ç»„æ¸¸æˆåˆ—è¡¨åæ’å…¥åˆ†éš”çº¿
                }
            }
    
            return htmlContent;
        }
    
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ fetchGameData å‡½æ•°
        window.onload = fetchGameData;
    </script>
    
    
    

</body>
<div class="dynamic-footer"></div>
</html>
